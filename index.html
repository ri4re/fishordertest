<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ - é¦™é­šæœƒå“¡å°ˆç”¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ========= å…±ç”¨æ¨£å¼ ========= */
    body {
      font-family: "Zen Maru Gothic", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #FFF6E7;
      padding: 24px;
      margin: 0;
      color: #333;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      background: #FFFDF7;
      border-radius: 18px;
      padding: 20px 20px 24px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;
      text-align: center;
      margin: 0 0 8px;
      letter-spacing: 1px;
    }

    h1 span {
      font-size: 26px;
    }

    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #87613B;
      margin-bottom: 14px;
    }

    .status-text {
      font-size: 12px;
      color: #555;
      margin: 2px 0 10px;
      line-height: 1.5;
    }

    label {
      font-size: 14px;
      display: block;
      margin: 8px 0 4px;
    }

    /* ========= æœå°‹å€å¡Š ========= */
    .search-block {
      margin-bottom: 6px;
    }

    .search-row-select {
      margin-bottom: 6px;
    }

    .search-row-select select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #FFD6A0;
      padding: 10px 12px;
      background: #FFFDF8;
      font-size: 14px;
      box-sizing: border-box;
    }

    .search-inline {
      display: flex;
      width: 100%;
      box-sizing: border-box;
    }

    .search-inline input[type="text"] {
      flex: 1 1 auto;
      border-radius: 999px 0 0 999px;
      border: 1px solid #FFB96A;
      border-right: none;
      padding: 10px 12px;
      font-size: 14px;
      background: #FFFDF8;
      box-sizing: border-box;
    }

    .search-inline button {
      flex: 0 0 auto;
      border-radius: 0 999px 999px 0;
      border: 1px solid #FFB96A;
      background: #FFB763;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 3px 0 #E39A3C;
      margin: 0;
    }

    .search-inline button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #E39A3C;
    }

    .tip {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
      line-height: 1.4;
    }

    .result {
      margin-top: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 16px 0 8px;
      color: #8B5E2C;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .section-title-icon {
      font-size: 14px;
    }

    .customer-box {
      background: #FFF4DA;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #FFD8A8;
      font-size: 14px;
      line-height: 1.7;
      margin-bottom: 4px;
      list-style: none;
    }

    .customer-box ul {
      margin: 0;
      padding-left: 18px;
    }

    .info-box {
      margin-top: 12px;
      font-size: 13px;
      background: #FFF0D8;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px dashed #FFBC75;
      color: #555;
      line-height: 1.5;
    }

    .empty {
      font-size: 14px;
      color: #999;
      text-align: center;
      margin-top: 12px;
    }

    /* ====== å•†å“å°çµï¼ˆç¸½ä»¶æ•¸ï¼‹ç¸½é‡‘é¡ï¼‰ ====== */
    .summary-box {
      font-size: 13px;
      background: #FFF4E0;
      border-radius: 10px;
      padding: 6px 10px;
      margin-bottom: 8px;
      color: #704214;
    }

    .summary-box b {
      font-weight: 700;
    }

    /* ====== ç‹€æ…‹ legend ====== */
    .status-legend {
      margin-top: 10px;
      font-size: 12px;
      background: #FFFDF5;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px dashed #FFE0B2;
      color: #555;
    }

    .status-legend ul {
      margin: 6px 0 0;
      padding-left: 18px;
    }

    .status-legend li {
      margin-bottom: 3px;
      list-style: none;
    }

    .legend-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      vertical-align: middle;
    }

    .legend-dot-pending {
      background: #FFD8A8;
    }

    .legend-dot-processing {
      background: #FFC9C9;
    }

    .legend-dot-arrived {
      background: #91A7FF;
    }

    .legend-dot-done {
      background: #8CE99A;
    }

    /* ====== æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰ ====== */
    .history-box {
      margin-top: 16px;
      font-size: 13px;
      background: #F5F0FF;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px dashed #B197FC;
      color: #4B3F72;
    }

    .history-title {
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .history-summary {
      margin-bottom: 6px;
    }

    .history-summary b {
      font-weight: 700;
    }

    .history-empty {
      font-size: 12px;
      color: #777;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      font-size: 12px;
    }

    .history-table th,
    .history-table td {
      border-bottom: 1px solid #E5DBFF;
      padding: 4px 2px;
      text-align: left;
      vertical-align: top;
    }

    .history-table th:nth-child(1),
    .history-table td:nth-child(1) {
      width: 18%;
      white-space: nowrap;
    }

    .history-table th:nth-child(2),
    .history-table td:nth-child(2) {
      width: 62%;
    }

    .history-table th:nth-child(3),
    .history-table td:nth-child(3) {
      width: 20%;
      white-space: nowrap;
      text-align: right;
    }

    /* ===== å¡ç‰‡ï¼ˆå•†å“ï¼‰ ===== */
    .card {
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid #FFD7B0;
      background: #FFF7E6;
      font-size: 14px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .card--pending {
      background: #FFF7E6;
      border-color: #FFD8A8;
    }

    .card--processing {
      background: #FFF3D9;
      border-color: #FFC078;
    }

    .card--arrived {
      background: #E8F4FF;
      border-color: #74C0FC;
    }

    .card--done {
      background: #E7FBEF;
      border-color: #69DB7C;
    }

    .card--default {
      background: #F8F9FA;
      border-color: #CED4DA;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 8px;
    }

    .card-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .card-title {
      font-weight: 700;
      margin-bottom: 2px;
      color: #7A4D1A;
      font-size: 15px;
    }

    .card-subline {
      font-size: 13px;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card-subline span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .card-toggle-icon {
      font-size: 16px;
      flex: 0 0 auto;
      color: #996633;
      transform: translateY(1px);
    }

    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      white-space: nowrap;
    }

    .badge--pending {
      background: #FFE8CC;
      color: #D9480F;
    }

    .badge--processing {
      background: #FFE3E3;
      color: #C92A2A;
    }

    .badge--arrived {
      background: #DCEFFF;
      color: #1C7ED6;
    }

    .badge--done {
      background: #D3F9D8;
      color: #2B8A3E;
    }

    .badge--default {
      background: #E9ECEF;
      color: #495057;
    }

    .card-body {
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.6;
      display: none;
    }

    .card-body.open {
      display: block;
    }

    .card-body-row {
      margin-bottom: 3px;
    }

    .link-btn {
      display: inline-block;
      padding: 4px 9px;
      border-radius: 10px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #FFB963;
      background: #FFF;
      margin-top: 3px;
    }

    .link-btn:hover {
      background: #FFF3E0;
    }

    /* ========= æ‰‹æ©Ÿ RWD ========= */
    @media (max-width: 768px) {
      body {
        padding: 0;
        background: #FFF6E7;
      }

      .wrap {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 20px 14px 24px;
        min-height: 100vh;
      }

      h1 {
        font-size: 22px;
        padding-bottom: 4px;
        border-bottom: 1px solid #FFE1B7;
      }

      .subtitle {
        margin-top: 4px;
        margin-bottom: 14px;
      }

      .search-row-select select {
        font-size: 15px;
        padding: 11px 12px;
      }

      .search-inline input[type="text"] {
        font-size: 16px;
        padding: 12px 12px;
      }

      .search-inline button {
        font-size: 16px;
        padding: 12px 16px;
      }

      .card {
        font-size: 14px;
      }

      .card-title {
        font-size: 15px;
      }

      .info-box {
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ§º è¨‚å–®æŸ¥è©¢ <span>é¦™é­šæœƒå“¡</span></h1>
  <div class="subtitle">è«‹è¼¸å…¥æ‚¨çš„æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æˆ– LINE åç¨±æŸ¥è©¢è¨‚å–®</div>
  <div class="status-text" id="loadStatus">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>

  <div class="search-block">
    <label>â‘  é¸æ“‡æŸ¥è©¢æ–¹å¼ï¼Œè¼¸å…¥è³‡æ–™</label>

    <div class="search-row-select">
      <select id="searchType">
        <option value="member">æœƒå“¡ç·¨è™Ÿ</option>
        <option value="email">ä¿¡ç®±</option>
        <option value="line">LINE åç¨±</option>
      </select>
    </div>

    <div class="search-inline">
      <input id="searchValue" type="text" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿ">
      <button type="button" onclick="searchOrder()">æœå°‹</button>
    </div>

    <div class="tip">
      âœ³ æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æœƒä»¥ã€Œå®Œå…¨ç›¸åŒã€æ¯”å°ã€‚<br>
      âœ³ LINE åç¨±æœƒä»¥ã€ŒåŒ…å«é—œéµå­—ã€æ¯”å°ï¼ˆä¾‹ï¼šè¼¸å…¥ã€Œé­šé­šã€æœƒæ‰¾åˆ°ã€Œé¦™é­šå¤§é˜ªä»£è³¼ğŸŸã€ï¼‰ã€‚<br>
    </div>
  </div>

  <div class="result" id="result"></div>
</div>

<script>
let rows = [];
let headerKeys = [];

/* å›ºå®šæ¬„ä½åç¨±ï¼ˆç…§ä½ çš„ CSVï¼‰ */
const COL_EMAIL    = "ä¿¡ç®±";
const COL_MEMBER   = "æœƒå“¡ç·¨è™Ÿ";
const COL_LINE     = "LINEåç¨±";
const COL_ITEM     = "å•†å“åç¨±";
const COL_SPEC     = "æ¬¾å¼";
const COL_QTY      = "æ•¸é‡";
const COL_STATUS   = "ç‹€æ…‹";
const COL_PRICE    = "é‡‘é¡";
const COL_URL      = "å•†å“ç¶²å€";
const COL_NOTE     = "å‚™è¨»";
const COL_DATE     = "æ›´æ–°æ—¥æœŸ";
const COL_SHIPDATE = "å‡ºè²¨æ—¥æœŸ";   // ğŸ”¹ æ–°å¢ï¼šå‡ºè²¨æ—¥æœŸæ¬„ä½

// è®€å– fishorder.csv
window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");
  const searchTypeEl = document.getElementById("searchType");
  const searchInputEl = document.getElementById("searchValue");

  // åˆ‡æ›æœå°‹æ–¹å¼æ™‚ï¼Œæ›´æ–° placeholder
  searchTypeEl.addEventListener("change", () => {
    const v = searchTypeEl.value;
    if (v === "member") {
      searchInputEl.placeholder = "è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿ";
    } else if (v === "email") {
      searchInputEl.placeholder = "è«‹è¼¸å…¥ä¿¡ç®±";
    } else {
      searchInputEl.placeholder = "è«‹è¼¸å…¥ LINE åç¨±é—œéµå­—";
    }
  });

  // Enter ç›´æ¥æœå°‹
  searchInputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      searchOrder();
    }
  });

  fetch("fishorder.csv")
    .then(resp => {
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp.text();
    })
    .then(text => {
      parseRawData(text);
      statusEl.textContent = `å·²è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œå…± ${rows.length} ç­†ã€‚`;
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "âš  ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèª fishorder.csv æ˜¯å¦èˆ‡æœ¬é åœ¨åŒä¸€è³‡æ–™å¤¾ï¼Œä¸¦é€é http æ–¹å¼é–‹å•Ÿã€‚";
    });
});

// è§£æ CSV/TSV
function parseRawData(raw) {
  const cleaned = raw.trim();
  const lines = cleaned.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) {
    rows = [];
    headerKeys = [];
    return;
  }

  const first = lines[0];
  const sep = first.includes("\t") ? "\t" : ",";
  headerKeys = first.split(sep).map(h => h.trim());

  rows = lines.slice(1).map(line => {
    const cols = line.split(sep);
    const o = {};
    headerKeys.forEach((h, i) => o[h] = (cols[i] || "").trim());
    return o;
  });
}

function parsePriceNumber(t){
  const n = parseFloat((t||"").replace(/[^\d.]/g,""));
  return isNaN(n)?null:n;
}

function parseQuantityNumber(t){
  const n = parseFloat((t||"1").replace(/[^\d.]/g,""));
  return isNaN(n)?1:n;
}

// ç‹€æ…‹â†’æ¨£å¼ key
function getStatusStyleKey(t){
  const s=(t||"").toLowerCase();
  if(s.includes("æœª")) return "pending";
  if(s.includes("è™•ç†")||s.includes("é€²è¡Œ")||s.includes("ä¸‹å–®")) return "processing";
  if(s.includes("åˆ°")||s.includes("è²¨")||s.includes("æŠµå°")) return "arrived";
  if(s.includes("å®Œæˆ")||s.includes("å¯„å‡º")||s.includes("çµå–®")) return "done";
  return "default";
}

function searchOrder(){
  const type=document.getElementById("searchType").value;
  const val=document.getElementById("searchValue").value.trim().toLowerCase();
  const out=document.getElementById("result");
  out.innerHTML="";

  if(!val){
    alert("è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹");
    return;
  }
  if(!rows.length){
    out.innerHTML='<div class="empty">å°šæœªè¼‰å…¥è³‡æ–™ï¼Œè«‹ç¢ºèª fishorder.csv æ˜¯å¦å­˜åœ¨ã€‚</div>';
    return;
  }

  // æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
  const hasEmail    = headerKeys.includes(COL_EMAIL);
  const hasMember   = headerKeys.includes(COL_MEMBER);
  const hasLine     = headerKeys.includes(COL_LINE);
  const hasShipDate = headerKeys.includes(COL_SHIPDATE);
  const hasDate     = headerKeys.includes(COL_DATE);

  let targetColName = null;
  if (type === "email") {
    if (!hasEmail) {
      out.innerHTML = `<div class="empty">è³‡æ–™ä¸­æ²’æœ‰ã€Œ${COL_EMAIL}ã€æ¬„ä½ï¼Œè«‹ç¢ºèª CSV æ¨™é¡Œã€‚</div>`;
      return;
    }
    targetColName = COL_EMAIL;
  } else if (type === "member") {
    if (!hasMember) {
      out.innerHTML = `<div class="empty">è³‡æ–™ä¸­æ²’æœ‰ã€Œ${COL_MEMBER}ã€æ¬„ä½ï¼Œè«‹ç¢ºèª CSV æ¨™é¡Œã€‚</div>`;
      return;
    }
    targetColName = COL_MEMBER;
  } else {
    if (!hasLine) {
      out.innerHTML = `<div class="empty">è³‡æ–™ä¸­æ²’æœ‰ã€Œ${COL_LINE}ã€æ¬„ä½ï¼Œè«‹ç¢ºèª CSV æ¨™é¡Œã€‚</div>`;
      return;
    }
    targetColName = COL_LINE;
  }

  const matches = rows.filter(r=>{
    const v=(r[targetColName]||"").toLowerCase();
    return type==="line" ? v.includes(val) : v===val;
  });

  if(!matches.length){
    out.innerHTML='<div class="empty">æŸ¥ç„¡ç¬¦åˆçš„è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèªè¼¸å…¥å…§å®¹æ˜¯å¦æ­£ç¢ºã€‚</div>';
    return;
  }

  let html = "";
  const firstRow = matches[0];

  // ========= å®¢äººè³‡è¨Š =========
  html += `<div class="section-title"><span class="section-title-icon">ğŸ‘¤</span> å®¢äººè³‡è¨Š</div>`;
  html += `<div class="customer-box"><ul>`;
  if(hasMember) html+=`<li>æœƒå“¡ç·¨è™Ÿï¼š${firstRow[COL_MEMBER]||""}</li>`;
  if(hasLine)   html+=`<li>LINE åç¨±ï¼š${firstRow[COL_LINE]||""}</li>`;
  if(hasEmail)  html+=`<li>ä¿¡ç®±ï¼š${firstRow[COL_EMAIL]||""}</li>`;
  html += `</ul></div>`;

  // ========= å•†å“åˆ—è¡¨ & å°çµ =========
  const hasItem   = headerKeys.includes(COL_ITEM);
  const hasSpec   = headerKeys.includes(COL_SPEC);
  const hasQty    = headerKeys.includes(COL_QTY);
  const hasStatus = headerKeys.includes(COL_STATUS);
  const hasPrice  = headerKeys.includes(COL_PRICE);
  const hasUrl    = headerKeys.includes(COL_URL);
  const hasNote   = headerKeys.includes(COL_NOTE);

  // å…ˆè¨ˆç®—ç¸½ä»¶æ•¸ï¼‹ç¸½é‡‘é¡
  let totalQtyAll = 0;
  let totalAmountAll = 0;
  matches.forEach(r => {
    const q = hasQty ? parseQuantityNumber(r[COL_QTY]) : 1;
    totalQtyAll += q;
    if (hasPrice) {
      const p = parsePriceNumber(r[COL_PRICE]);
      if (p !== null) {
        totalAmountAll += p * q;
      }
    }
  });

  if(!hasItem && !hasSpec){
    // æ²’æœ‰å•†å“æ¬„ä½å°±ç›´æ¥ç°¡å–®åˆ—å‡ºåŸå§‹æ¬„ä½
    html += `<div class="section-title"><span class="section-title-icon">ğŸ“¦</span> å•†å“åˆ—è¡¨ï¼ˆç°¡æ˜“é¡¯ç¤ºï¼‰</div>`;
    html += `<div class="summary-box">
      æœ¬æ¬¡è¨‚å–®å…± <b>${totalQtyAll}</b> ä»¶å•†å“${
        (hasPrice && totalAmountAll)
          ? `ï¼Œåˆè¨ˆé‡‘é¡ç´„ <b>Â¥ ${totalAmountAll.toLocaleString("ja-JP")}</b>`
          : ""
      }
    </div>`;

    matches.forEach((r, idx)=>{
      const stText = hasStatus ? (r[COL_STATUS] || "") : "";
      const stKey  = getStatusStyleKey(stText);
      html += `<div class="card card--${stKey}">`;
      html += `<div class="card-header" onclick="toggleCardBody(this)">
                 <div class="card-main">
                   <div class="card-title">
                     ç¬¬ ${idx+1} ç­†è¨‚å–®
                     ${hasStatus ? `<span class="badge badge--${stKey}">${stText}</span>` : ""}
                   </div>
                 </div>
                 <div class="card-toggle-icon">âŒ„</div>
               </div>`;
      html += `<div class="card-body${idx===0?" open":""}">`;
      headerKeys.forEach(k=>{
        html += `<div class="card-body-row">${k}ï¼š${r[k]||""}</div>`;
      });
      html += `</div></div>`;
    });

    html += `
      <div class="info-box">
        ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
        ç›®å‰å› ç‚º CSV æ¨™é¡Œä¸­æ²’æœ‰ã€Œå•†å“åç¨± / æ¬¾å¼ã€æ¬„ä½ï¼Œæš«ä»¥åŸå§‹æ¬„ä½é¡¯ç¤ºã€‚
      </div>
    `;

    // ç‹€æ…‹ legend
    html += statusLegendHtml();

    out.innerHTML = html;
    return;
  }

  html += `<div class="section-title"><span class="section-title-icon">ğŸ“¦</span> å•†å“åˆ—è¡¨</div>`;

  // å°çµé¡¯ç¤ºåœ¨å•†å“åˆ—è¡¨æ¨™é¡Œä¸‹é¢
  html += `<div class="summary-box">
    æœ¬æ¬¡è¨‚å–®å…± <b>${totalQtyAll}</b> ä»¶å•†å“${
      (hasPrice && totalAmountAll)
        ? `ï¼Œåˆè¨ˆé‡‘é¡ç´„ <b>Â¥ ${totalAmountAll.toLocaleString("ja-JP")}</b>`
        : ""
    }
  </div>`;

  // ä¾ å•†å“åç¨± + æ¬¾å¼ åˆ†çµ„
  const group={};
  matches.forEach(r=>{
    const itemVal = hasItem ? (r[COL_ITEM]||"") : "";
    const specVal = hasSpec ? (r[COL_SPEC]||"") : "";
    const key=itemVal+"||"+specVal;
    if(!group[key]) group[key]=[];
    group[key].push(r);
  });

  Object.keys(group).forEach((key, idx)=>{
    const list=group[key];
    const last=list[list.length-1];

    const itemVal = hasItem ? (list[0][COL_ITEM]||"") : "";
    const specVal = hasSpec ? (list[0][COL_SPEC]||"") : "";

    const qtyTotal=list.map(r=>{
      return hasQty ? parseQuantityNumber(r[COL_QTY]) : 1;
    }).reduce((a,b)=>a+b,0);

    const priceBase = hasPrice ? parsePriceNumber(list[0][COL_PRICE]) : null;
    const total=priceBase?priceBase*qtyTotal:"";

    const noteCombined = hasNote
      ? [...new Set(list.map(r=>r[COL_NOTE]).filter(Boolean))].join(" / ")
      : "";

    const statusText = hasStatus ? (last[COL_STATUS] || "") : "";
    const statusKeyStyle = getStatusStyleKey(statusText);

    html += `<div class="card card--${statusKeyStyle}">`;

    // headerï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
    html += `
      <div class="card-header" onclick="toggleCardBody(this)">
        <div class="card-main">
          <div class="card-title">
            ${itemVal || "æœªå¡«å•†å“"}${specVal?`ï¼ˆ${specVal}ï¼‰`:""}
            ${hasStatus ? `<span class="badge badge--${statusKeyStyle}">${statusText}</span>` : ""}
          </div>
          <div class="card-subline">
            <span>æ•¸é‡ï¼š${qtyTotal}</span>
            ${
              hasPrice
                ? `<span>é‡‘é¡ï¼š${list[0][COL_PRICE] || ""}${total?`ï¼ˆåˆè¨ˆï¼š${total}ï¼‰`:""}</span>`
                : ""
            }
          </div>
        </div>
        <div class="card-toggle-icon">âŒ„</div>
      </div>
    `;

    // bodyï¼ˆè©³ç´°è³‡è¨Šï¼‰
    html += `<div class="card-body${idx===0?" open":""}">`;
    if(hasUrl && last[COL_URL]) {
      html += `<div class="card-body-row">ğŸ”— å•†å“é€£çµï¼š<a class="link-btn" href="${last[COL_URL]}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å•†å“é </a></div>`;
    }
    if(noteCombined) {
      html += `<div class="card-body-row">ğŸ“ å‚™è¨»ï¼š${noteCombined}</div>`;
    }
    // ğŸšš å‡ºè²¨æ—¥æœŸå„ªå…ˆé¡¯ç¤º
    if (hasShipDate && last[COL_SHIPDATE]) {
      html += `<div class="card-body-row">ğŸšš å‡ºè²¨æ—¥æœŸï¼š${last[COL_SHIPDATE]}</div>`;
    }
    // ä¿ç•™æ›´æ–°æ—¥æœŸç•¶å‚™ç”¨è³‡è¨Š
    if (hasDate && last[COL_DATE]) {
      html += `<div class="card-body-row">ğŸ“… æ›´æ–°æ—¥æœŸï¼š${last[COL_DATE]}</div>`;
    }
    html += `</div>`; // end body

    html += `</div>`; // end card
  });

  html += `
    <div class="info-box">
      ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
      æˆ‘å€‘æœƒä¾ç…§ç•«é¢ä¸­çš„ã€Œè¨‚å–®ç‹€æ…‹ã€èˆ‡ã€Œæ›´æ–°æ—¥æœŸ / å‡ºè²¨æ—¥æœŸã€ç‚ºæ‚¨ç¢ºèªæœ€æ–°æƒ…æ³ã€‚ğŸ™
    </div>
  `;

  // ======== æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰ ========
  if (hasStatus && (hasShipDate || hasDate)) {
    const doneRows = matches.filter(r => getStatusStyleKey(r[COL_STATUS]) === "done");
    html += buildHistoryByDateSection(doneRows, hasItem, hasSpec, hasQty, hasPrice, hasShipDate, hasDate);
  }

  // ç‹€æ…‹ legend
  html += statusLegendHtml();

  out.innerHTML=html;
}

function statusLegendHtml(){
  return `
    <div class="status-legend">
      <div>ğŸ“Œ ç‹€æ…‹èªªæ˜ï¼ˆçµ¦æ‚¨åƒè€ƒï¼‰</div>
      <ul>
        <li><span class="legend-dot legend-dot-pending"></span>ã€Œæœªã€å­—ç›¸é—œï¼šå°šæœªè™•ç†æˆ–ç­‰å¾…ä¸­</li>
        <li><span class="legend-dot legend-dot-processing"></span>ã€Œè™•ç† / ä¸‹å–® / é‹é€ä¸­ã€ï¼šè¨‚å–®å·²åœ¨è™•ç†æµç¨‹ä¸­</li>
        <li><span class="legend-dot legend-dot-arrived"></span>ã€Œåˆ°è²¨ / æŠµå°ã€ï¼šå•†å“å·²æŠµé”æ—¥æœ¬æˆ–å°ç£ï¼Œæº–å‚™å¾ŒçºŒå‡ºè²¨</li>
        <li><span class="legend-dot legend-dot-done"></span>ã€Œå®Œæˆ / çµå–® / å·²å¯„å‡ºã€ï¼šæ­¤å•†å“å·²è™•ç†å®Œç•¢</li>
      </ul>
    </div>
  `;
}

/**
 * ä¾ã€Œå‡ºè²¨æ—¥æœŸã€çµ±æ•´å·²çµå–®ç´€éŒ„
 * æœ‰å‡ºè²¨æ—¥æœŸå„ªå…ˆç”¨ï¼Œæ²’æœ‰æ‰é€€å›ç”¨æ›´æ–°æ—¥æœŸ
 */
function buildHistoryByDateSection(doneRows, hasItem, hasSpec, hasQty, hasPrice, hasShipDate, hasDate) {
  if (!doneRows || !doneRows.length) {
    return `
      <div class="history-box">
        <div class="history-title">ğŸ“˜ æ­·å²è¨‚å–®ï¼ˆå·²çµå–®ï¼‰</div>
        <div class="history-empty">ç›®å‰å°šç„¡å·²çµå–®çš„å•†å“ï¼Œå®Œæˆå‡ºè²¨å¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚</div>
      </div>
    `;
  }

  // ä¾æ—¥æœŸåˆ†çµ„ï¼šå„ªå…ˆä½¿ç”¨å‡ºè²¨æ—¥æœŸï¼Œå…¶æ¬¡æ›´æ–°æ—¥æœŸ
  const dateGroup = {};
  doneRows.forEach(r => {
    let d = "æœªå¡«æ—¥æœŸ";
    if (hasShipDate && r[COL_SHIPDATE]) {
      d = r[COL_SHIPDATE];
    } else if (hasDate && r[COL_DATE]) {
      d = r[COL_DATE];
    }
    if (!dateGroup[d]) dateGroup[d] = [];
    dateGroup[d].push(r);
  });

  // æ—¥æœŸæ’åºï¼ˆå­—ä¸²æ’åºï¼Œé€šå¸¸ YYYY/MM/DD æˆ– YYYY-MM-DD æœƒæ­£å¸¸ï¼‰
  const dateKeys = Object.keys(dateGroup).sort();

  let totalDoneQty = 0;
  let totalDoneAmount = 0;
  let rowsHtml = "";

  dateKeys.forEach(dateStr => {
    const list = dateGroup[dateStr];

    // åŒä¸€æ—¥æœŸå…§ï¼Œå†ä¾å•†å“ï¼‹æ¬¾å¼çµ±æ•´æ•¸é‡èˆ‡é‡‘é¡
    const itemGroup = {};
    list.forEach(r => {
      const itemVal = hasItem ? (r[COL_ITEM] || "") : "";
      const specVal = hasSpec ? (r[COL_SPEC] || "") : "";
      const key = itemVal + "||" + specVal;
      if (!itemGroup[key]) {
        itemGroup[key] = {
          item: itemVal,
          spec: specVal,
          qty: 0,
          price: null
        };
      }
      const q = hasQty ? parseQuantityNumber(r[COL_QTY]) : 1;
      itemGroup[key].qty += q;

      if (hasPrice) {
        const p = parsePriceNumber(r[COL_PRICE]);
        if (p !== null) {
          itemGroup[key].price = p; // åŒå•†å“ï¼‹æ¬¾å¼åƒ¹æ ¼è¦–ç‚ºç›¸åŒ
        }
      }
    });

    // çµ„å‡ºå•†å“æ–‡å­— & è¨ˆç®—ç•¶æ—¥ç¸½é‡‘é¡
    let dayTotal = 0;
    const itemLines = Object.values(itemGroup).map(info => {
      const labelItem = info.item || "æœªå¡«å•†å“";
      const labelSpec = info.spec ? `ï¼ˆ${info.spec}ï¼‰` : "";
      const label = `${labelItem}${labelSpec} x${info.qty}`;
      totalDoneQty += info.qty;

      if (hasPrice && info.price !== null) {
        const sub = info.price * info.qty;
        dayTotal += sub;
        return `${label}ï¼ˆå°è¨ˆ Â¥${sub.toLocaleString("ja-JP")}ï¼‰`;
      } else {
        return label;
      }
    });

    if (hasPrice) {
      totalDoneAmount += dayTotal;
    }

    rowsHtml += `
      <tr>
        <td>${dateStr}</td>
        <td>${itemLines.join(" / ")}</td>
        <td>${hasPrice && dayTotal ? `Â¥ ${dayTotal.toLocaleString("ja-JP")}` : ""}</td>
      </tr>
    `;
  });

  return `
    <div class="history-box">
      <div class="history-title">ğŸ“˜ æ­·å²è¨‚å–®ï¼ˆä¾å‡ºè²¨æ—¥æœŸçµ±æ•´ï¼‰</div>
      <div class="history-summary">
        å·²çµå–®å•†å“å…± <b>${totalDoneQty}</b> ä»¶${
          (totalDoneAmount && !isNaN(totalDoneAmount))
            ? `ï¼Œç´¯è¨ˆé‡‘é¡ç´„ <b>Â¥ ${totalDoneAmount.toLocaleString("ja-JP")}</b>`
            : ""
        }
      </div>
      <table class="history-table">
        <thead>
          <tr>
            <th>å‡ºè²¨æ—¥æœŸ</th>
            <th>å‡ºè²¨å•†å“</th>
            <th>ç•¶æ—¥å°è¨ˆ</th>
          </tr>
        </thead>
        <tbody>
          ${rowsHtml}
        </tbody>
      </table>
    </div>
  `;
}

// é» header å±•é–‹/æ”¶åˆ
function toggleCardBody(headerEl){
  const body = headerEl.nextElementSibling;
  if(!body) return;
  body.classList.toggle("open");
}
</script>

</body>
</html>
