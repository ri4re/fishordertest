<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ - é¦™é­šæœƒå“¡å°ˆç”¨</title>
  <style>
    body {
      font-family: "Zen Maru Gothic", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #FFF9E5;
      padding: 20px;
    }
    .wrap {
      max-width: 700px;
      margin: 0 auto;
      background: #FFFFFF;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 6px;
    }
    h1 span {
      font-size: 24px;
    }
    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #777;
      margin-bottom: 10px;
    }
    .status-text {
      font-size: 12px;
      color: #555;
      margin-top: 4px;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    label {
      font-size: 14px;
      display: block;
      margin: 8px 0 4px;
    }
    input[type="text"],
    select {
      border-radius: 10px;
      border: 1px solid #FFD8A8;
      padding: 8px;
      box-sizing: border-box;
      font-size: 14px;
      background: #FFFDF8;
    }
    button {
      margin-top: 8px;
      padding: 9px 16px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      background: #FFB963;
    }
    button:hover {
      background: #FFA94D;
    }
    .tip {
      font-size: 12px;
      color: #777;
      margin-top: 4px;
      line-height: 1.4;
    }
    .result {
      margin-top: 14px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 700;
      margin: 10px 0 6px;
    }
    .customer-box {
      background: #FFF7E0;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid #FFD8A8;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    .card {
      background: #FFF7E0;
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid #FFD8A8;
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 4px;
    }
    .empty {
      font-size: 14px;
      color: #999;
      text-align: center;
      margin-top: 12px;
    }
    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
    }
    .badge-gray {
      background: #E9ECEF;
      color: #495057;
    }
    .badge-orange {
      background: #FFE8CC;
      color: #D9480F;
    }
    .badge-blue {
      background: #E7F5FF;
      color: #1864AB;
    }
    .badge-green {
      background: #D3F9D8;
      color: #2B8A3E;
    }
    .badge-default {
      background: #FFE8C7;
      color: #8D5B20;
    }
    .info-box {
      margin-top: 12px;
      font-size: 12px;
      background: #FFF0E6;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px dashed #FFB963;
      color: #555;
      line-height: 1.5;
    }
    .search-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }
    .search-row select {
      flex: 0 0 140px;
    }
    .search-row input {
      flex: 1 1 auto;
      min-width: 0;
    }
    .link-btn {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #FFB963;
      background: #FFF;
      margin-top: 2px;
    }
    .link-btn:hover {
      background: #FFF3E0;
    }
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* è¶… APP ç‰ˆï¼ˆé¦™é­šå¥¶æ²¹æ©˜ UIï¼‰ */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

@media (max-width: 768px) {

  /* èƒŒæ™¯æ›´åƒ App */
  body {
    margin: 0;
    padding: 0;
    background: #FFF6E7;
  }

  /* ä¸»å®¹å™¨åƒæ•´å€‹è¢å¹•å¯¬ */
  .wrap {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 20px 16px;
    border-radius: 0;
    background: #FFFDF7;
    min-height: 100vh; /* è®Šå…¨è¢å¹• */
    box-shadow: none;
  }

  /* æ¨™é¡Œæ›´åƒ App æ¨™é¡Œåˆ— */
  h1 {
    font-size: 20px;
    margin-top: 0;
    padding-top: 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid #FFE1B7;
  }

  /* å‰¯æ¨™ */
  .subtitle {
    font-size: 12px;
    margin-bottom: 14px;
    color: #8A6E4A;
  }

  /* æœå°‹å€åŸŸèˆ‡è¼¸å…¥æ¡† */
  .search-row {
    flex-direction: column;
    gap: 10px;
    margin-bottom: 10px;
  }

  input[type="text"],
  select {
    width: 100%;
    font-size: 16px;
    padding: 14px 12px;
    border-radius: 12px;
    border: 1.6px solid #FFA94D;
    background: #FFFDF8;
  }
  
  /* æŸ¥è©¢æŒ‰éˆ•ï¼šæ›´åƒ App å¤§æŒ‰éˆ• */
  button {
    width: 100%;
    font-size: 17px;
    padding: 14px;
    border-radius: 14px;
    background: #FFB763;
    font-weight: 600;
    box-shadow: 0 3px 0 #E39A3C;
  }
  button:active {
    transform: translateY(2px);
    box-shadow: 0 1px 0 #E39A3C;
  }

  /* å®¢äººå€å¡Š */
  .customer-box {
    background: #FFF4DA;
    border-radius: 12px;
    padding: 12px;
    border: 1px solid #FFD8A8;
    font-size: 15px;
    line-height: 1.7;
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin-top: 20px;
    margin-bottom: 8px;
    color: #8B5E2C;
  }

  /* æ¯ç­†å•†å“å¡ç‰‡ */
  .card {
    border-radius: 12px;
    background: #FFF4E6;
    padding: 14px 14px;
    margin-bottom: 14px;
    border: 1px solid #FFD7B0;
    font-size: 15px;
  }

  .card-title {
    font-size: 16px;
    margin-bottom: 6px;
    font-weight: 700;
    color: #7A4D1A;
  }

  .link-btn {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 10px;
  }

  /* æç¤ºå€æ›´åƒç³»çµ±è¨Šæ¯ */
  .info-box {
    background: #FFF0D8;
    padding: 12px;
    border-radius: 12px;
    font-size: 14px;
    border: 1px dashed #FFBC75;
  }
}
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ§º è¨‚å–®æŸ¥è©¢ <span>é¦™é­šæœƒå“¡</span></h1>
  <div class="subtitle">è«‹è¼¸å…¥æ‚¨çš„æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æˆ– LINE åç¨±æŸ¥è©¢è¨‚å–®</div>
  <div class="status-text" id="loadStatus">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>

  <label>â‘  é¸æ“‡æŸ¥è©¢æ–¹å¼ï¼Œè¼¸å…¥è³‡æ–™</label>
  <div class="search-row">
    <select id="searchType">
      <option value="member">æœƒå“¡ç·¨è™Ÿ</option>
      <option value="email">ä¿¡ç®±</option>
      <option value="line">LINE åç¨±</option>
    </select>
    <input id="searchValue" type="text" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿ / ä¿¡ç®± / LINE åç¨±">
  </div>

  <button onclick="searchOrder()">æŸ¥è©¢æˆ‘çš„è¨‚å–®</button>

  <div class="tip">
    âœ³ æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æœƒä»¥ã€Œå®Œå…¨ç›¸åŒã€æ¯”å°ã€‚<br>
    âœ³ LINE åç¨±æœƒä»¥ã€ŒåŒ…å«é—œéµå­—ã€æ¯”å°ï¼ˆä¾‹ï¼šè¼¸å…¥ã€Œé­šé­šã€æœƒæ‰¾åˆ°ã€Œé¦™é­šå¤§é˜ªä»£è³¼ğŸŸã€ï¼‰ã€‚<br>
  </div>

  <div class="result" id="result"></div>
</div>

<script>
let rows = [];
let headerKeys = [];

// è®€å–åŒè³‡æ–™å¤¾è£¡çš„ fishorder.csv
window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");

  fetch("fishorder.csv")
    .then(resp => {
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp.text();
    })
    .then(text => {
      parseRawData(text);
      statusEl.textContent = `å·²è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œå…± ${rows.length} ç­†ã€‚`;
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "âš  ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™";
    });
});

function parseRawData(raw) {
  const cleaned = raw.trim();
  const lines = cleaned.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return;

  const first = lines[0];
  const sep = first.includes("\t") ? "\t" : ",";
  headerKeys = first.split(sep).map(h => h.trim());

  rows = lines.slice(1).map(line => {
    const cols = line.split(sep);
    const o = {};
    headerKeys.forEach((h, i) => o[h] = (cols[i] || "").trim());
    return o;
  });
}

function parsePriceNumber(t){
  const n = parseFloat((t||"").replace(/[^\d.]/g,""));
  return isNaN(n)?null:n;
}
function parseQuantityNumber(t){
  const n = parseFloat((t||"1").replace(/[^\d.]/g,""));
  return isNaN(n)?1:n;
}

function getStatusBadgeClass(t){
  const s=(t||"").toLowerCase();
  if(s.includes("æœª")) return "badge-gray";
  if(s.includes("é€²")||s.includes("è™•ç†")) return "badge-orange";
  if(s.includes("åˆ°")||s.includes("è²¨")) return "badge-blue";
  if(s.includes("å®Œæˆ")||s.includes("å¯„å‡º")) return "badge-green";
  return "badge-default";
}

function searchOrder(){
  const type=document.getElementById("searchType").value;
  const val=document.getElementById("searchValue").value.trim().toLowerCase();
  const out=document.getElementById("result");
  out.innerHTML="";

  if(!val){alert("è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹");return;}
  if(!rows.length){out.innerHTML="å°šæœªè¼‰å…¥è³‡æ–™";return;}

  const emailKey  = headerKeys.find(k=>/ä¿¡ç®±|mail/i.test(k));
  const memberKey = headerKeys.find(k=>/æœƒå“¡|member/i.test(k));
  const lineKey   = headerKeys.find(k=>/line/i.test(k));

  let targetKey = type==="email"
      ? emailKey
      : type==="member"
      ? memberKey
      : lineKey;

  const matches = rows.filter(r=>{
    const v=(r[targetKey]||"").toLowerCase();
    return type==="line" ? v.includes(val) : v===val;
  });

  if(!matches.length){out.innerHTML="æŸ¥ç„¡è³‡æ–™";return;}

  const nameKey   = headerKeys.find(k=>/å®¢äººåç¨±|å§“å|åå­—|é¡¯ç¤ºåç¨±|å®¢|å/i.test(k));
  const itemKey   = headerKeys.find(k=>/å•†å“åç¨±|å•†å“|å“é …/i.test(k));
  const specKey   = headerKeys.find(k=>/è¦æ ¼|æ¬¾å¼|ç‰ˆæœ¬|ver/i.test(k));
  const statusKey = headerKeys.find(k=>/ç‹€æ…‹|é€²åº¦/i.test(k));
  const priceKey  = headerKeys.find(k=>/é‡‘é¡|åƒ¹æ ¼|åƒ¹/i.test(k));
  const qtyKey    = headerKeys.find(k=>/æ•¸é‡|qty|ä»¶æ•¸|å€‹æ•¸|æ•¸ç›®/i.test(k));
  const noteKey   = headerKeys.find(k=>/å‚™è¨»|å‚™è€ƒ|ã‚³ãƒ¡ãƒ³ãƒˆ/i.test(k));
  const urlKey    = headerKeys.find(k=>/å•†å“ç¶²å€|å•†å“URL|å•†å“é€£çµ|é€£çµ|link|product ?url|url/i.test(k));
  const dateKey   = headerKeys.find(k=>/æ›´æ–°æ—¥æœŸ|æ›´æ–°æ™‚é–“|æœ€å¾Œæ›´æ–°|update|date/i.test(k));

  let html = "";
  const f = matches[0];

  html += `<div class="section-title">ğŸ‘¤ å®¢äººè³‡è¨Š</div>`;
  html += `<div class="customer-box"><ul>`;
  if(nameKey)   html+=`<li>åç¨±ï¼š${f[nameKey]||""}</li>`;
  if(memberKey) html+=`<li>æœƒå“¡IDï¼š${f[memberKey]||""}</li>`;
  if(lineKey)   html+=`<li>LINEï¼š${f[lineKey]||""}</li>`;
  if(emailKey)  html+=`<li>ä¿¡ç®±ï¼š${f[emailKey]||""}</li>`;
  html += `</ul></div>`;

  const group={};
  matches.forEach(r=>{
    const k=(r[itemKey]||"")+"||"+(r[specKey]||"");
    if(!group[k]) group[k]=[];
    group[k].push(r);
  });

  html += `<div class="section-title">ğŸ“¦ å•†å“åˆ—è¡¨</div>`;

  Object.keys(group).forEach(k=>{
    const list=group[k];
    const last=list[list.length-1];

    const itemVal=list[0][itemKey]||"";
    const specVal=list[0][specKey]||"";

    const qtyTotal=list.map(r=>parseQuantityNumber(r[qtyKey])).reduce((a,b)=>a+b,0);
    const priceBase=parsePriceNumber(list[0][priceKey]);
    const total=priceBase?priceBase*qtyTotal:"";

    const noteCombined=[...new Set(list.map(r=>r[noteKey]).filter(Boolean))].join(" / ");

    html += `<div class="card">`;
    html += `<div class="card-title">ğŸ“¦ ${itemVal}${specVal?`ï¼ˆ${specVal}ï¼‰`:""} <span class="badge ${getStatusBadgeClass(last[statusKey])}">${last[statusKey]||""}</span></div>`;
    html += `<div>ğŸ”¢ æ•¸é‡ï¼š${qtyTotal}</div>`;
    if(priceKey) html += `<div>ğŸ’° é‡‘é¡ï¼š${list[0][priceKey]}${total?`ï¼ˆåˆè¨ˆï¼š${total}ï¼‰`:""}</div>`;
    if(urlKey && last[urlKey]) html += `<div>ğŸ”— å•†å“é€£çµï¼š<a class="link-btn" href="${last[urlKey]}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å•†å“é </a></div>`;
    if(noteCombined) html += `<div>ğŸ“ å‚™è¨»ï¼š${noteCombined}</div>`;
    if(dateKey && last[dateKey]) html += `<div>ğŸ“… æ›´æ–°æ—¥æœŸï¼š${last[dateKey]}</div>`;
    html += `</div>`;
  });

  html += `
    <div class="info-box">
      ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
      æˆ‘å€‘æœƒä¾ç…§ç•«é¢ä¸­çš„ã€Œè¨‚å–®ç‹€æ…‹ã€èˆ‡ã€Œæ›´æ–°æ—¥æœŸã€ç‚ºæ‚¨ç¢ºèªæœ€æ–°æƒ…æ³ã€‚ğŸ™
    </div>
  `;

  out.innerHTML=html;
}
</script>

</body>
</html>
