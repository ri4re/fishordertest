<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®æŸ¥è©¢ - é¦™é­šæœƒå“¡å°ˆç”¨</title>
  <!-- æ‰‹æ©Ÿç‰ˆå¿…è¦ï¼šè®“å¯¬åº¦è·Ÿè£ç½®ä¸€æ¨£ -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ========= å…±ç”¨æ¨£å¼ ========= */
    body {
      font-family: "Zen Maru Gothic", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #FFF6E7;
      padding: 24px;
      margin: 0;
      color: #333;
    }

    .wrap {
      max-width: 720px;
      margin: 0 auto;
      background: #FFFDF7;
      border-radius: 18px;
      padding: 20px 20px 24px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      box-sizing: border-box;
    }

    h1 {
      font-size: 24px;              /* æ¨™é¡Œå­—æ”¾å¤§ä¸€é» */
      text-align: center;
      margin: 0 0 8px;
      letter-spacing: 1px;
    }
    h1 span {
      font-size: 26px;
    }

    .subtitle {
      font-size: 12px;
      text-align: center;
      color: #87613B;
      margin-bottom: 14px;
    }

    .status-text {
      font-size: 12px;
      color: #555;
      margin: 2px 0 10px;
      line-height: 1.5;
    }

    label {
      font-size: 14px;
      display: block;
      margin: 8px 0 4px;
    }

    /* æœå°‹å€å¡Šï¼šselect + æœå°‹æ¡† + æŒ‰éˆ•é»åœ¨ä¸€èµ· */
    .search-block {
      margin-bottom: 6px;
    }

    .search-row-select {
      margin-bottom: 6px;
    }

    .search-row-select select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #FFD6A0;
      padding: 10px 12px;
      background: #FFFDF8;
      font-size: 14px;
      box-sizing: border-box;
    }

    .search-inline {
      display: flex;
      width: 100%;
      box-sizing: border-box;
    }

    .search-inline input[type="text"] {
      flex: 1 1 auto;
      border-radius: 999px 0 0 999px;
      border: 1px solid #FFB96A;
      border-right: none;
      padding: 10px 12px;
      font-size: 14px;
      background: #FFFDF8;
      box-sizing: border-box;
    }

    .search-inline button {
      flex: 0 0 auto;
      border-radius: 0 999px 999px 0;
      border: 1px solid #FFB96A;
      background: #FFB763;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 3px 0 #E39A3C;
      margin: 0;
    }

    .search-inline button:active {
      transform: translateY(2px);
      box-shadow: 0 1px 0 #E39A3C;
    }

    .tip {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
      line-height: 1.4;
    }

    .result {
      margin-top: 16px;
    }

    .section-title {
      font-size: 15px;
      font-weight: 700;
      margin: 16px 0 8px;
      color: #8B5E2C;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .section-title-icon {
      font-size: 14px;  /* ICON ç¨å¾®å£“å°ä¸€é» */
    }

    .customer-box {
      background: #FFF4DA;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid #FFD8A8;
      font-size: 14px;
      line-height: 1.7;
      margin-bottom: 4px;
      list-style: none;
    }

    .customer-box ul {
      margin: 0;
      padding-left: 18px;
    }

    .info-box {
      margin-top: 12px;
      font-size: 13px;
      background: #FFF0D8;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px dashed #FFBC75;
      color: #555;
      line-height: 1.5;
    }

    .empty {
      font-size: 14px;
      color: #999;
      text-align: center;
      margin-top: 12px;
    }

    /* ===== å¡ç‰‡ï¼ˆå•†å“ï¼‰ ===== */

    .card {
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
      border: 1px solid #FFD7B0;
      background: #FFF7E6;
      font-size: 14px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* ç‹€æ…‹é…è‰²ï¼šä¾ç‹€æ…‹è‡ªå‹•è®Šå¡ç‰‡é¡è‰² */
    .card--pending {
      background: #FFF7E6;
      border-color: #FFD8A8;
    }
    .card--processing {
      background: #FFF3D9;
      border-color: #FFC078;
    }
    .card--arrived {
      background: #E8F4FF;
      border-color: #74C0FC;
    }
    .card--done {
      background: #E7FBEF;
      border-color: #69DB7C;
    }
    .card--default {
      background: #F8F9FA;
      border-color: #CED4DA;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      gap: 8px;
    }

    .card-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .card-title {
      font-weight: 700;
      margin-bottom: 2px;
      color: #7A4D1A;
      font-size: 15px;
    }

    .card-subline {
      font-size: 13px;
      color: #555;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card-subline span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }

    .card-toggle-icon {
      font-size: 16px;
      flex: 0 0 auto;
      color: #996633;
      transform: translateY(1px);
    }

    .badge {
      display: inline-block;
      padding: 1px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-left: 4px;
      white-space: nowrap;
    }

    .badge--pending {
      background: #FFE8CC;
      color: #D9480F;
    }
    .badge--processing {
      background: #FFE3E3;
      color: #C92A2A;
    }
    .badge--arrived {
      background: #DCEFFF;
      color: #1C7ED6;
    }
    .badge--done {
      background: #D3F9D8;
      color: #2B8A3E;
    }
    .badge--default {
      background: #E9ECEF;
      color: #495057;
    }

    .card-body {
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.6;
      display: none;             /* é è¨­æ”¶åˆ */
    }

    .card-body.open {
      display: block;           /* å±•é–‹ */
    }

    .card-body-row {
      margin-bottom: 3px;
    }

    .link-btn {
      display: inline-block;
      padding: 4px 9px;
      border-radius: 10px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #FFB963;
      background: #FFF;
      margin-top: 3px;
    }
    .link-btn:hover {
      background: #FFF3E0;
    }

    /* ========= æ‰‹æ©Ÿ RWDï¼šæ›´åƒ App ========= */
    @media (max-width: 768px) {
      body {
        padding: 0;
        background: #FFF6E7;
      }

      .wrap {
        max-width: 100%;
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 20px 14px 24px;
        min-height: 100vh;
      }

      h1 {
        font-size: 22px;
        padding-bottom: 4px;
        border-bottom: 1px solid #FFE1B7;
      }

      .subtitle {
        margin-top: 4px;
        margin-bottom: 14px;
      }

      .search-row-select select {
        font-size: 15px;
        padding: 11px 12px;
      }

      .search-inline input[type="text"] {
        font-size: 16px;
        padding: 12px 12px;
      }
      .search-inline button {
        font-size: 16px;
        padding: 12px 16px;
      }

      .card {
        font-size: 14px;
      }
      .card-title {
        font-size: 15px;
      }
      .info-box {
        font-size: 13px;
      }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>ğŸ§º è¨‚å–®æŸ¥è©¢ <span>é¦™é­šæœƒå“¡</span></h1>
  <div class="subtitle">è«‹è¼¸å…¥æ‚¨çš„æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æˆ– LINE åç¨±æŸ¥è©¢è¨‚å–®</div>
  <div class="status-text" id="loadStatus">è³‡æ–™è¼‰å…¥ä¸­â€¦</div>

  <div class="search-block">
    <label>â‘  é¸æ“‡æŸ¥è©¢æ–¹å¼ï¼Œè¼¸å…¥è³‡æ–™</label>

    <div class="search-row-select">
      <select id="searchType">
        <option value="member">æœƒå“¡ç·¨è™Ÿ</option>
        <option value="email">ä¿¡ç®±</option>
        <option value="line">LINE åç¨±</option>
      </select>
    </div>

    <div class="search-inline">
      <input id="searchValue" type="text" placeholder="è«‹è¼¸å…¥æœƒå“¡ç·¨è™Ÿ / ä¿¡ç®± / LINE åç¨±">
      <button onclick="searchOrder()">æœå°‹</button>
    </div>

    <div class="tip">
      âœ³ æœƒå“¡ç·¨è™Ÿã€ä¿¡ç®±æœƒä»¥ã€Œå®Œå…¨ç›¸åŒã€æ¯”å°ã€‚<br>
      âœ³ LINE åç¨±æœƒä»¥ã€ŒåŒ…å«é—œéµå­—ã€æ¯”å°ï¼ˆä¾‹ï¼šè¼¸å…¥ã€Œé­šé­šã€æœƒæ‰¾åˆ°ã€Œé¦™é­šå¤§é˜ªä»£è³¼ğŸŸã€ï¼‰ã€‚<br>
    </div>
  </div>

  <div class="result" id="result"></div>
</div>

<script>
let rows = [];
let headerKeys = [];

// è®€å–åŒè³‡æ–™å¤¾è£¡çš„ fishorder.csv
window.addEventListener("DOMContentLoaded", () => {
  const statusEl = document.getElementById("loadStatus");

  fetch("fishorder.csv")
    .then(resp => {
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      return resp.text();
    })
    .then(text => {
      parseRawData(text);
      statusEl.textContent = `å·²è¼‰å…¥è¨‚å–®è³‡æ–™ï¼Œå…± ${rows.length} ç­†ã€‚`;
    })
    .catch(err => {
      console.error(err);
      statusEl.textContent = "âš  ç„¡æ³•è®€å–è¨‚å–®è³‡æ–™";
    });
});

// è§£æ CSV
function parseRawData(raw) {
  const cleaned = raw.trim();
  const lines = cleaned.split(/\r?\n/).filter(l => l.trim());
  if (lines.length < 2) return;

  const first = lines[0];
  const sep = first.includes("\t") ? "\t" : ",";
  headerKeys = first.split(sep).map(h => h.trim());

  rows = lines.slice(1).map(line => {
    const cols = line.split(sep);
    const o = {};
    headerKeys.forEach((h, i) => o[h] = (cols[i] || "").trim());
    return o;
  });
}

function parsePriceNumber(t){
  const n = parseFloat((t||"").replace(/[^\d.]/g,""));
  return isNaN(n)?null:n;
}
function parseQuantityNumber(t){
  const n = parseFloat((t||"1").replace(/[^\d.]/g,""));
  return isNaN(n)?1:n;
}

// ç‹€æ…‹â†’æ¨£å¼ key
function getStatusStyleKey(t){
  const s=(t||"").toLowerCase();
  if(s.includes("æœª")) return "pending";
  if(s.includes("è™•ç†")||s.includes("é€²è¡Œ")||s.includes("ä¸‹å–®")) return "processing";
  if(s.includes("åˆ°")||s.includes("è²¨")||s.includes("æŠµå°")) return "arrived";
  if(s.includes("å®Œæˆ")||s.includes("å¯„å‡º")||s.includes("çµå–®")) return "done";
  return "default";
}

function searchOrder(){
  const type=document.getElementById("searchType").value;
  const val=document.getElementById("searchValue").value.trim().toLowerCase();
  const out=document.getElementById("result");
  out.innerHTML="";

  if(!val){alert("è«‹è¼¸å…¥æŸ¥è©¢å…§å®¹");return;}
  if(!rows.length){out.innerHTML="å°šæœªè¼‰å…¥è³‡æ–™";return;}

  const emailKey  = headerKeys.find(k=>/ä¿¡ç®±|mail/i.test(k));
  const memberKey = headerKeys.find(k=>/æœƒå“¡|member/i.test(k));
  const lineKey   = headerKeys.find(k=>/line/i.test(k));

  let targetKey = type==="email"
      ? emailKey
      : type==="member"
      ? memberKey
      : lineKey;

  const matches = rows.filter(r=>{
    const v=(r[targetKey]||"").toLowerCase();
    return type==="line" ? v.includes(val) : v===val;
  });

  if(!matches.length){out.innerHTML="æŸ¥ç„¡è³‡æ–™";return;}

  const nameKey   = headerKeys.find(k=>/å®¢äººåç¨±|å§“å|åå­—|é¡¯ç¤ºåç¨±|å®¢|å/i.test(k));
  const itemKey   = headerKeys.find(k=>/å•†å“åç¨±|å•†å“|å“é …/i.test(k));
  const specKey   = headerKeys.find(k=>/è¦æ ¼|æ¬¾å¼|ç‰ˆæœ¬|ver/i.test(k));
  const statusKey = headerKeys.find(k=>/ç‹€æ…‹|é€²åº¦/i.test(k));
  const priceKey  = headerKeys.find(k=>/é‡‘é¡|åƒ¹æ ¼|åƒ¹/i.test(k));
  const qtyKey    = headerKeys.find(k=>/æ•¸é‡|qty|ä»¶æ•¸|å€‹æ•¸|æ•¸ç›®/i.test(k));
  const noteKey   = headerKeys.find(k=>/å‚™è¨»|å‚™è€ƒ|ã‚³ãƒ¡ãƒ³ãƒˆ/i.test(k));
  const urlKey    = headerKeys.find(k=>/å•†å“ç¶²å€|å•†å“URL|å•†å“é€£çµ|é€£çµ|link|product ?url|url/i.test(k));
  const dateKey   = headerKeys.find(k=>/æ›´æ–°æ—¥æœŸ|æ›´æ–°æ™‚é–“|æœ€å¾Œæ›´æ–°|update|date/i.test(k));

  let html = "";
  const f = matches[0];

  // å®¢äººè³‡è¨Š
  html += `<div class="section-title"><span class="section-title-icon">ğŸ‘¤</span> å®¢äººè³‡è¨Š</div>`;
  html += `<div class="customer-box"><ul>`;
  if(nameKey)   html+=`<li>åç¨±ï¼š${f[nameKey]||""}</li>`;
  if(memberKey) html+=`<li>æœƒå“¡IDï¼š${f[memberKey]||""}</li>`;
  if(lineKey)   html+=`<li>LINEï¼š${f[lineKey]||""}</li>`;
  if(emailKey)  html+=`<li>ä¿¡ç®±ï¼š${f[emailKey]||""}</li>`;
  html += `</ul></div>`;

  // ä¾ã€Œå•†å“ + è¦æ ¼ã€åˆ†çµ„
  const group={};
  matches.forEach(r=>{
    const k=(r[itemKey]||"")+"||"+(r[specKey]||"");
    if(!group[k]) group[k]=[];
    group[k].push(r);
  });

  html += `<div class="section-title"><span class="section-title-icon">ğŸ“¦</span> å•†å“åˆ—è¡¨</div>`;

  Object.keys(group).forEach((k, idx)=>{
    const list=group[k];
    const last=list[list.length-1];

    const itemVal=list[0][itemKey]||"";
    const specVal=list[0][specKey]||"";

    const qtyTotal=list.map(r=>parseQuantityNumber(r[qtyKey])).reduce((a,b)=>a+b,0);
    const priceBase=parsePriceNumber(list[0][priceKey]);
    const total=priceBase?priceBase*qtyTotal:"";

    const noteCombined=[...new Set(list.map(r=>r[noteKey]).filter(Boolean))].join(" / ");

    const statusText = last[statusKey] || "";
    const statusKeyStyle = getStatusStyleKey(statusText);

    html += `<div class="card card--${statusKeyStyle}">`;

    // headerï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
    html += `
      <div class="card-header" onclick="toggleCardBody(this)">
        <div class="card-main">
          <div class="card-title">
            ${itemVal}${specVal?`ï¼ˆ${specVal}ï¼‰`:""}
            <span class="badge badge--${statusKeyStyle}">${statusText}</span>
          </div>
          <div class="card-subline">
            <span>æ•¸é‡ï¼š${qtyTotal}</span>
            ${priceKey ? `<span>é‡‘é¡ï¼š${list[0][priceKey]}${total?`ï¼ˆåˆè¨ˆï¼š${total}ï¼‰`:""}</span>` : ""}
          </div>
        </div>
        <div class="card-toggle-icon">âŒ„</div>
      </div>
    `;

    // bodyï¼ˆè©³ç´°è³‡è¨Šï¼Œå¯æ”¶åˆï¼‰
    html += `<div class="card-body${idx===0?" open":""}">`;
    if(urlKey && last[urlKey]) {
      html += `<div class="card-body-row">ğŸ”— å•†å“é€£çµï¼š<a class="link-btn" href="${last[urlKey]}" target="_blank" rel="noopener noreferrer">æŸ¥çœ‹å•†å“é </a></div>`;
    }
    if(noteCombined) {
      html += `<div class="card-body-row">ğŸ“ å‚™è¨»ï¼š${noteCombined}</div>`;
    }
    if(dateKey && last[dateKey]) {
      html += `<div class="card-body-row">ğŸ“… æ›´æ–°æ—¥æœŸï¼š${last[dateKey]}</div>`;
    }
    html += `</div>`; // end body

    html += `</div>`; // end card
  });

  html += `
    <div class="info-box">
      ğŸ”” å¦‚å°è¨‚å–®é€²åº¦æœ‰ä»»ä½•ç–‘å•ï¼Œè«‹å°‡æ­¤ç•«é¢æˆªåœ–ï¼Œä¸¦é€é LINE å®˜æ–¹å¸³è™Ÿèˆ‡æˆ‘å€‘è¯ç¹«ã€‚<br>
      æˆ‘å€‘æœƒä¾ç…§ç•«é¢ä¸­çš„ã€Œè¨‚å–®ç‹€æ…‹ã€èˆ‡ã€Œæ›´æ–°æ—¥æœŸã€ç‚ºæ‚¨ç¢ºèªæœ€æ–°æƒ…æ³ã€‚ğŸ™
    </div>
  `;

  out.innerHTML=html;
}

// é» header å±•é–‹/æ”¶åˆ
function toggleCardBody(headerEl){
  const body = headerEl.nextElementSibling;
  if(!body) return;
  body.classList.toggle("open");
}
</script>

</body>
</html>
